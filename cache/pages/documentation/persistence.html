<h2 id="_1">持久化接口</h2>
<ul>
<li>接口：<code>io.github.quickmsg.common.message.MessageRegistry</code></li>
</ul>
<blockquote>
<p>主要提供 session消息 &amp;&amp; 保留消息的持久化 </p>
</blockquote>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>List<SessionMessage> getSessionMessages(String clientIdentifier)</td>
<td>获取连接下线后的session消息</td>
</tr>
<tr>
<td>void saveSessionMessages(SessionMessage sessionMessage)</td>
<td>保存连接下线后的session消息</td>
</tr>
<tr>
<td>void saveRetainMessage(RetainMessage retainMessage)</td>
<td>保留Topic保留消息</td>
</tr>
<tr>
<td>List<RetainMessage> getRetainMessage(String topic)</td>
<td>获取Topic保留消息</td>
</tr>
</tbody>
</table>
<h3 id="session">使用数据库去存储session/保留消息</h3>
<ul>
<li>引入DB依赖</li>
</ul>
<pre class="code literal-block">    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>io.github.quickmsg<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>smqtt-persistent-db<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0.5<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

 ```

- 引入驱动依赖

&gt; 根据版本引入 mysql/pg/oracle等驱动依赖


```xml
    　　<span class="c">&lt;!--mysql驱动包--&gt;</span>
     <span class="nt">&lt;dependency&gt;</span>
           <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
           <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
           <span class="nt">&lt;version&gt;</span>5.1.35<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
</pre>
<ul>
<li>服务启动时config.properties 添加 配置参数</li>
</ul>
<pre class="code literal-block"><span class="c"># 数据库配置</span>
<span class="na">db.driverClassName</span><span class="o">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="na">db.url</span><span class="o">=</span><span class="s">jdbc:mysql://127.0.0.1:3306/smqtt?characterEncoding=utf-8&amp;useSSL=false&amp;useInformationSchema=true&amp;serverTimezone=UTC</span>
<span class="na">db.username</span><span class="o">=</span><span class="s">root</span>
<span class="na">db.password</span><span class="o">=</span><span class="s">123</span>
<span class="c"># 连接池初始化连接数</span>
<span class="na">db.initialSize</span><span class="o">=</span><span class="s">10</span>
<span class="c"># 连接池中最多支持多少个活动会话</span>
<span class="na">db.maxActive</span><span class="o">=</span><span class="s">300</span>
<span class="c"># 向连接池中请求连接时,超过maxWait的值后,认为本次请求失败</span>
<span class="na">db.maxWait</span><span class="o">=</span><span class="s">60000</span>
<span class="c"># 回收空闲连接时，将保证至少有minIdle个连接</span>
<span class="na">db.minIdle</span><span class="o">=</span><span class="s">2</span>
</pre>
<ul>
<li>启动服务后会自动生成session表跟retain表</li>
</ul>
<h3 id="redissession">使用Redis去存储session/保留消息</h3>
<ul>
<li>引入依赖</li>
</ul>
<pre class="code literal-block"> <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.github.quickmsg<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>smqtt-persistent-redis<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.5<span class="nt">&lt;/version&gt;</span>
 <span class="nt">&lt;/dependency&gt;</span>
</pre>
<ul>
<li>config.properties 配置参数</li>
</ul>
<pre class="code literal-block"><span class="c"># redis配置</span>
<span class="c"># 单机模式：single 哨兵模式：sentinel 集群模式：cluster</span>
<span class="na">redis.mode</span><span class="o">=</span><span class="s">single</span>
<span class="c"># 数据库</span>
<span class="na">redis.database</span><span class="o">=</span><span class="s">0</span>
<span class="c"># 密码</span>
<span class="na">redis.password</span><span class="o">=</span>
<span class="c"># 超时时间</span>
<span class="na">redis.timeout</span><span class="o">=</span><span class="s">3000</span>
<span class="c"># 最小空闲数</span>
<span class="na">redis.pool.min.idle</span><span class="o">=</span><span class="s">8</span>
<span class="c"># 连接超时时间(毫秒)</span>
<span class="na">redis.pool.conn.timeout</span><span class="o">=</span><span class="s">3000</span>
<span class="c"># 连接池大小</span>
<span class="na">redis.pool.size</span><span class="o">=</span><span class="s">10</span>

<span class="c"># 单机配置</span>
<span class="na">redis.single.address</span><span class="o">=</span><span class="s">127.0.0.1:6379</span>

<span class="c"># 集群配置</span>
<span class="c"># 集群扫描间隔时间(毫秒)</span>
<span class="na">redis.cluster.scan.interval</span><span class="o">=</span><span class="s">1000</span>
<span class="c"># 节点</span>
<span class="na">redis.cluster.nodes</span><span class="o">=</span><span class="s">127.0.0.1:7000,127.0.0.1:7001,127.0.0.1:7002,127.0.0.1:7003,127.0.0.1:7004,127.0.0.1:7005</span>
<span class="c"># 读取操作的负载均衡模式</span>
<span class="na">redis.cluster.read.mode</span><span class="o">=</span><span class="s">SLAVE</span>
<span class="c"># 命令失败重试次数</span>
<span class="na">redis.cluster.retry.attempts</span><span class="o">=</span><span class="s">3</span>
<span class="c"># 从节点连接池大小</span>
<span class="na">redis.cluster.slave.connection.pool.size</span><span class="o">=</span><span class="s">64</span>
<span class="c"># 主节点最小空闲连接数</span>
<span class="na">redis.cluster.master.connection.pool.size</span><span class="o">=</span><span class="s">64</span>
<span class="c"># 命令重试发送时间间隔(毫秒)</span>
<span class="na">redis.cluster.retry.interval</span><span class="o">=</span><span class="s">1500</span>

<span class="c"># 哨兵配置</span>
<span class="c"># master名称</span>
<span class="na">redis.sentinel.master</span><span class="o">=</span><span class="s">mymaster</span>
<span class="c"># 节点</span>
<span class="na">redis.sentinel.nodes</span><span class="o">=</span><span class="s">127.0.0.1:26379,127.0.0.1:26379,127.0.0.1:26379</span>
</pre>
<h3 id="_2">自定义实现持久化</h3>
<p>resources/META-INF/services 目录下新建
名为<code>io.github.quickmsg.common.message.MessageRegistry</code>文件,
将自定义实现类全限定名写入文件中即可完成注入。</p>